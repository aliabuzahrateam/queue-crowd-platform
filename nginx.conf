events {}

http {
    # Frontend upstreams
    upstream admin_frontend {
        server admin-frontend:4173;
    }
    upstream kiosk_frontend {
        server kiosk-frontend:4173;
    }
    upstream public_display_frontend {
        server public-display-frontend:4173;
    }
    upstream staff_frontend {
        server staff-frontend:4173;
    }

    # Backend upstreams
    upstream auth_service {
        server auth-service:4000;
    }
    upstream branch_service {
        server branch-service:4000;
    }
    upstream crowding_service {
        server crowding-service:4000;
    }
    upstream feedback_service {
        server feedback-service:4000;
    }
    upstream notification_service {
        server notification-service:4000;
    }
    upstream queue_service {
        server queue-service:4000;
    }

    server {
        listen 80;
        listen 443 ssl;
        server_name localhost;

        # SSL config (self-signed for dev)
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Custom error pages
        error_page 404 /custom_404.html;
        error_page 500 502 503 504 /custom_50x.html;
        location = /custom_404.html {
            root /etc/nginx/html;
            internal;
        }
        location = /custom_50x.html {
            root /etc/nginx/html;
            internal;
        }

        # Frontend routes
        location /admin/ {
            proxy_pass http://admin_frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /kiosk/ {
            proxy_pass http://kiosk_frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /public/ {
            proxy_pass http://public_display_frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /staff/ {
            proxy_pass http://staff_frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # API routes
        location /api/auth/ {
            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/branch/ {
            proxy_pass http://branch_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/crowding/ {
            proxy_pass http://crowding_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/feedback/ {
            proxy_pass http://feedback_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/notification/ {
            proxy_pass http://notification_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/queue/ {
            proxy_pass http://queue_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Static file caching for frontends (adjust path as needed)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, no-transform";
        }

        # Default fallback (optional)
        location / {
            return 404;
        }
    }
}